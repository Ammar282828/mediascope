import React, { useState, useEffect } from 'react';
import axios from 'axios';
import {
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
} from 'recharts';

const API_BASE = 'http://localhost:8000/api';

interface Article {
  id: string;
  headline: string;
  content_preview: string;
  content?: string;
  publication_date: string;
  sentiment_score: number;
  sentiment_label: string;
  topic_label: string;
  entities: Array<{text: string; type: string}>;
  word_count?: number;
}

interface TrendData {
  date: string;
  count: number;
}

const api = {
  searchKeyword: async (query: string, filters?: any) => {
    const response = await axios.post(`${API_BASE}/search/keyword`, {
      query,
      ...filters,
      limit: 100
    });
    return response.data;
  },

  searchEntity: async (entityName: string, filters?: any) => {
    const response = await axios.post(`${API_BASE}/search/entity`, {
      entity_name: entityName,
      ...filters,
      limit: 100
    });
    return response.data;
  },

  getKeywordTrend: async (keywords: string[], startDate: string, endDate: string) => {
    const response = await axios.post(`${API_BASE}/analytics/keyword-trend`, {
      keywords,
      start_date: startDate,
      end_date: endDate,
      granularity: 'day'
    });
    return response.data;
  },

  getTopEntities: async (type?: string, limit = 10) => {
    const response = await axios.get(`${API_BASE}/analytics/top-entities-fixed`, {
      params: { entity_type: type, limit }
    });
    return response.data;
  },

  getSentimentOverview: async () => {
    const response = await axios.get(`${API_BASE}/analytics/sentiment-fixed`);
    return response.data;
  },

  getArticleDetail: async (articleId: string) => {
    const response = await axios.get(`${API_BASE}/articles/${articleId}`);
    return response.data;
  },

  getKeywordSuggestions: async (limit = 100) => {
    const response = await axios.get(`${API_BASE}/suggestions/keywords`, {
      params: { limit }
    });
    return response.data;
  },

  deleteArticle: async (articleId: string) => {
    const response = await axios.delete(`${API_BASE}/api/articles/${articleId}`);
    return response.data;
  },

  deleteNewspaper: async (newspaperId: string) => {
    const response = await axios.delete(`${API_BASE}/api/newspapers/${newspaperId}`);
    return response.data;
  },

  generateAISummary: async (startDate: string, endDate: string, topic?: string) => {
    const response = await axios.post(`${API_BASE}/analytics/ai-summary`, {
      start_date: startDate,
      end_date: endDate,
      topic
    });
    return response.data;
  }
};

const SearchPanel: React.FC<{
  onResults: (results: any) => void;
}> = ({ onResults }) => {
  const [searchType, setSearchType] = useState<'keyword' | 'entity'>('keyword');
  const [query, setQuery] = useState('');
  const [loading, setLoading] = useState(false);
  const [suggestions, setSuggestions] = useState<any[]>([]);

  useEffect(() => {
    const loadSuggestions = async () => {
      try {
        const data = await api.getKeywordSuggestions(30);
        setSuggestions(data.suggestions || []);
      } catch (error) {
        console.error('Failed to load suggestions:', error);
      }
    };
    loadSuggestions();
  }, []);

  const handleSearch = async () => {
    if (!query.trim()) return;

    setLoading(true);
    try {
      if (searchType === 'keyword') {
        const data = await api.searchKeyword(query);
        onResults(data);
      } else {
        const data = await api.searchEntity(query);
        onResults(data);
      }
    } catch (error) {
      console.error('Search error:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="search-panel">
      <div className="search-header">
        <h2>ğŸ” Search Dawn Archives (1990-1992)</h2>
        <div className="search-type-tabs">
          <button
            className={searchType === 'keyword' ? 'active' : ''}
            onClick={() => setSearchType('keyword')}
          >
            Keyword Search
          </button>
          <button
            className={searchType === 'entity' ? 'active' : ''}
            onClick={() => setSearchType('entity')}
          >
            Entity Search
          </button>
        </div>
      </div>

      <div className="search-input-group">
        <input
          type="text"
          placeholder={
            searchType === 'keyword'
              ? 'Search articles by keyword...'
              : 'Search by person, organization, or location...'
          }
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
          className="search-input"
        />
        <button
          onClick={handleSearch}
          disabled={loading}
          className="search-button"
        >
          {loading ? 'Searching...' : 'ğŸ” Search'}
        </button>
      </div>

      {suggestions.length > 0 && (
        <div className="suggestions-panel">
          <h4>ğŸ’¡ Popular Keywords (Click to search):</h4>
          <div className="suggestion-tags">
            {suggestions.slice(0, 20).map((s, idx) => (
              <button
                key={idx}
                className="suggestion-tag"
                onClick={() => {
                  setQuery(s.keyword);
                  setSearchType('entity');
                  setTimeout(() => handleSearch(), 100);
                }}
              >
                {s.keyword} <span className="freq-badge">({s.frequency})</span>
              </button>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

const ArticleList: React.FC<{
  articles: Article[];
}> = ({ articles }) => {
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [fullArticles, setFullArticles] = useState<{[key: string]: Article}>({});
  const [loadingId, setLoadingId] = useState<string | null>(null);

  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  const handleDeleteArticle = async (articleId: string) => {
    if (!window.confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
      return;
    }
    
    try {
      await api.deleteArticle(articleId);
      alert('Article deleted successfully');
      setArticles(articles.filter(a => a.id !== articleId));
      if (expandedId === articleId) {
        setExpandedId(null);
      }
    } catch (err) {
      alert('Error deleting article: ' + err);
    }
  };

  const handleArticleClick = async (articleId: string) => {
    if (expandedId === articleId) {
      setExpandedId(null);
      return;
    }

    if (fullArticles[articleId]) {
      setExpandedId(articleId);
      return;
    }

    setLoadingId(articleId);
    setExpandedId(articleId);
    
    try {
      const data = await api.getArticleDetail(articleId);
      setFullArticles(prev => ({...prev, [articleId]: data}));
    } catch (error) {
      console.error('Failed to load article:', error);
      setExpandedId(null);
    } finally {
      setLoadingId(null);
    }
  };

  const getSentimentColor = (label: string) => {
    switch (label) {
      case 'positive': return '#10b981';
      case 'negative': return '#ef4444';
      default: return '#6b7280';
    }
  };

  const getSentimentEmoji = (label: string) => {
    switch (label) {
      case 'positive': return 'ğŸ˜Š';
      case 'negative': return 'ğŸ˜';
      default: return 'ğŸ˜';
    }
  };

  return (
    <div className="article-list">
      {articles.map((article) => {
        const isExpanded = expandedId === article.id;
        const fullArticle = fullArticles[article.id];
        const isLoading = loadingId === article.id;

        return (
          <div key={article.id} className="article-card">
            <div 
              className="article-header"
              onClick={() => handleArticleClick(article.id)}
              style={{ cursor: 'pointer' }}
            >
              <h3 className="article-headline">
                {isExpanded ? 'ğŸ“– ' : 'ğŸ“„ '}
                {article.headline}
              </h3>
              <span className="article-date">
                {new Date(article.publication_date).toLocaleDateString()}
              </span>
            </div>

            <div className="article-content-preview">
              {isExpanded && fullArticle ? (
                <div className="full-article-content">
                  <div style={{ whiteSpace: 'pre-wrap', lineHeight: '1.6' }}>
                    {fullArticle.content}
                  </div>
                  {fullArticle.word_count && (
                    <div style={{ marginTop: '16px', color: '#6b7280', fontSize: '14px' }}>
                      ğŸ“Š Word count: {fullArticle.word_count}
                    </div>
                  )}
                </div>
              ) : isLoading ? (
                <p style={{ color: '#3b82f6' }}>â³ Loading full article...</p>
              ) : (
                <div onClick={() => handleArticleClick(article.id)} style={{ cursor: 'pointer' }}>
                  {article.content_preview}...
                  <span style={{ color: '#3b82f6', marginLeft: '8px', fontWeight: '600' }}>
                    ğŸ‘‰ Click to read full article
                  </span>
                </div>
              )}
            </div>

            <div className="article-meta">
              <div
                className="sentiment-badge"
                style={{ backgroundColor: getSentimentColor(article.sentiment_label) }}
              >
                {getSentimentEmoji(article.sentiment_label)} {article.sentiment_label}
                <span className="sentiment-score">
                  ({article.sentiment_score?.toFixed(2)})
                </span>
              </div>

              {article.topic_label && (
                <div className="topic-badge">
                  ğŸ“š {article.topic_label}
                </div>
              )}

              {article.entities && article.entities.length > 0 && (
                <div className="entities-list">
                  {article.entities.slice(0, 5).map((entity, idx) => (
                    <span key={idx} className="entity-tag">
                      {entity.type === 'PERSON' && 'ğŸ‘¤'}
                      {entity.type === 'ORG' && 'ğŸ¢'}
                      {entity.type === 'GPE' && 'ğŸ“'}
                      {entity.text}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
};

const KeywordTrendChart: React.FC = () => {
  const [keywords, setKeywords] = useState<string[]>(['karachi']);
  const [newKeyword, setNewKeyword] = useState('');
  const [trendData, setTrendData] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);

  const loadTrend = async () => {
    if (keywords.length === 0) return;

    setLoading(true);
    try {
      const data = await api.getKeywordTrend(keywords, '1990-01-01', '1992-12-31');

      const dates = new Set<string>();
      if (data.trends) {
        Object.values(data.trends).forEach((trend: any) => {
          if (Array.isArray(trend)) {
            trend.forEach((point: TrendData) => dates.add(point.date));
          }
        });
      }

      const chartData = Array.from(dates).sort().map(date => {
        const point: any = { date: new Date(date).toLocaleDateString() };
        keywords.forEach(kw => {
          const trend = data.trends?.[kw] || [];
          const match = Array.isArray(trend) ? trend.find((p: TrendData) => p.date === date) : null;
          point[kw] = match ? match.count : 0;
        });
        return point;
      });

      setTrendData(chartData);
    } catch (error) {
      console.error('Error loading trends:', error);
      setTrendData([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadTrend();
  }, [keywords]);

  const addKeyword = () => {
    if (newKeyword && !keywords.includes(newKeyword.toLowerCase())) {
      setKeywords([...keywords, newKeyword.toLowerCase()]);
      setNewKeyword('');
    }
  };

  const removeKeyword = (kw: string) => {
    if (keywords.length > 1) {
      setKeywords(keywords.filter(k => k !== kw));
    }
  };

  const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];

  return (
    <div className="trend-chart-panel">
      <h2>ğŸ“ˆ Keyword Trends Over Time</h2>
      
      <div className="keyword-input-group">
        <input
          type="text"
          placeholder="Add keyword to track..."
          value={newKeyword}
          onChange={(e) => setNewKeyword(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && addKeyword()}
        />
        <button onClick={addKeyword} className="add-button">+ Add Keyword</button>
      </div>

      <div className="active-keywords">
        {keywords.map((kw, idx) => (
          <span key={kw} className="keyword-badge" style={{ backgroundColor: colors[idx % colors.length] }}>
            {kw}
            {keywords.length > 1 && <button onClick={() => removeKeyword(kw)}>Ã—</button>}
          </span>
        ))}
      </div>

      {loading ? (
        <p>Loading trends...</p>
      ) : trendData.length > 0 ? (
        <ResponsiveContainer width="100%" height={400}>
          <LineChart data={trendData}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="date" />
            <YAxis />
            <Tooltip />
            <Legend />
            {keywords.map((kw, idx) => (
              <Line
                key={kw}
                type="monotone"
                dataKey={kw}
                stroke={colors[idx % colors.length]}
                strokeWidth={2}
              />
            ))}
          </LineChart>
        </ResponsiveContainer>
      ) : (
        <div style={{ padding: '40px', textAlign: 'center', color: '#6b7280' }}>
          No trend data available for these keywords. Try different keywords or check if articles exist in the database.
        </div>
      )}
    </div>
  );
};

const AISummaryPanel: React.FC = () => {
  const [startDate, setStartDate] = useState('1990-01-01');
  const [endDate, setEndDate] = useState('1992-12-31');
  const [topic, setTopic] = useState('');
  const [summary, setSummary] = useState<any>(null);
  const [loading, setLoading] = useState(false);

  const generateSummary = async () => {
    setLoading(true);
    setSummary(null);
    try {
      const data = await api.generateAISummary(startDate, endDate, topic || undefined);
      setSummary(data);
    } catch (error) {
      console.error('Failed to generate summary:', error);
      setSummary({ error: 'Failed to generate summary. Please try again.' });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="ai-summary-panel">
      <h2>ğŸ¤– AI-Powered Summary</h2>
      <p style={{ color: '#6b7280', marginBottom: '20px' }}>
        Generate an intelligent summary of articles from a specific time period
      </p>
      
      <div className="summary-controls">
        <div className="date-inputs">
          <label>
            Start Date:
            <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} />
          </label>
          <label>
            End Date:
            <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)} />
          </label>
        </div>
        
        <div className="topic-input">
          <label>
            Topic Filter (optional):
            <input 
              type="text" 
              placeholder="e.g., politics, economy, sports"
              value={topic}
              onChange={(e) => setTopic(e.target.value)}
            />
          </label>
        </div>

        <button onClick={generateSummary} disabled={loading} className="generate-button">
          {loading ? 'â³ Generating...' : 'âœ¨ Generate AI Summary'}
        </button>
      </div>

      {summary && !summary.error && (
        <div className="summary-result">
          <div className="summary-meta">
            <div><strong>ğŸ“… Period:</strong> {summary.date_range}</div>
            <div><strong>ğŸ“° Articles:</strong> {summary.article_count}</div>
            {summary.topic && <div><strong>ğŸ·ï¸ Topic:</strong> {summary.topic}</div>}
          </div>
          <div className="summary-text">
            <h3>ğŸ“ Summary:</h3>
            <p style={{ whiteSpace: 'pre-wrap', lineHeight: '1.8' }}>{summary.summary}</p>
          </div>
        </div>
      )}

      {summary && summary.error && (
        <div className="summary-error">
          âš ï¸ {summary.error}
        </div>
      )}
    </div>
  );
};

const TopEntitiesPanel: React.FC = () => {
  const [entityType, setEntityType] = useState<string>('');
  const [entities, setEntities] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);

  const loadTopEntities = async () => {
    setLoading(true);
    try {
      const data = await api.getTopEntities(entityType || undefined, 15);
      setEntities(data.entities || []);
    } catch (error) {
      console.error('Error loading entities:', error);
      setEntities([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadTopEntities();
  }, [entityType]);

  const getEntityIcon = (type: string) => {
    switch(type) {
      case 'PERSON': return 'ğŸ‘¤';
      case 'ORG': return 'ğŸ¢';
      case 'GPE': return 'ğŸ“';
      default: return 'ğŸ·ï¸';
    }
  };

  return (
    <div className="top-entities-panel">
      <h3>ğŸ† Top Entities</h3>
      
      <select value={entityType} onChange={(e) => setEntityType(e.target.value)} className="entity-type-select">
        <option value="">All Types</option>
        <option value="PERSON">ğŸ‘¤ People</option>
        <option value="ORG">ğŸ¢ Organizations</option>
        <option value="GPE">ğŸ“ Locations</option>
      </select>

      {loading ? (
        <p>Loading entities...</p>
      ) : entities.length > 0 ? (
        <div className="entities-grid">
          {entities.map((entity, idx) => (
            <div key={idx} className="entity-item">
              <div className="entity-rank">#{idx + 1}</div>
              <div className="entity-info">
                <div className="entity-name">
                  {getEntityIcon(entity.type)} {entity.text}
                </div>
                <div className="entity-type-label">{entity.type}</div>
              </div>
              <div className="entity-count">{entity.count}</div>
            </div>
          ))}
        </div>
      ) : (
        <p>No entities found</p>
      )}
    </div>
  );
};

const SentimentDistribution: React.FC = () => {
  const [data, setData] = useState<any>(null);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    const loadData = async () => {
      setLoading(true);
      try {
        const result = await api.getSentimentOverview();
        setData(result);
      } catch (error) {
        console.error('Error loading sentiment data:', error);
      } finally {
        setLoading(false);
      }
    };
    loadData();
  }, []);

  if (loading) return <p>Loading sentiment data...</p>;
  if (!data || data.total === 0) return <p>No sentiment data available</p>;

  const positivePercent = (data.positive / data.total) * 100;
  const neutralPercent = (data.neutral / data.total) * 100;
  const negativePercent = (data.negative / data.total) * 100;

  return (
    <div className="sentiment-distribution">
      <h3>ğŸ˜ŠğŸ˜ğŸ˜ Sentiment Analysis</h3>
      <div className="sentiment-stats">
        <div className="stat-item positive">
          <div className="stat-label">ğŸ˜Š Positive</div>
          <div className="stat-value">{data.positive}</div>
          <div className="stat-percent">{positivePercent.toFixed(1)}%</div>
        </div>
        <div className="stat-item neutral">
          <div className="stat-label">ğŸ˜ Neutral</div>
          <div className="stat-value">{data.neutral}</div>
          <div className="stat-percent">{neutralPercent.toFixed(1)}%</div>
        </div>
        <div className="stat-item negative">
          <div className="stat-label">ğŸ˜ Negative</div>
          <div className="stat-value">{data.negative}</div>
          <div className="stat-percent">{negativePercent.toFixed(1)}%</div>
        </div>
      </div>
      <div className="sentiment-bar-container">
        <div className="sentiment-bar positive" style={{ width: `${positivePercent}%` }}></div>
        <div className="sentiment-bar neutral" style={{ width: `${neutralPercent}%` }}></div>
        <div className="sentiment-bar negative" style={{ width: `${negativePercent}%` }}></div>
      </div>
      <div className="total-articles">Total Articles: {data.total}</div>
    </div>
  );
};

const MediaScopeDashboard: React.FC = () => {
  const [searchResults, setSearchResults] = useState<any>(null);
  const [activeTab, setActiveTab] = useState<'search' | 'trends' | 'analytics'>('search');

  useEffect(() => {
    const loadArticles = async () => {
      try {
        const response = await axios.get('http://localhost:8000/api/articles');
        setSearchResults({
          total: response.data.articles.length,
          articles: response.data.articles
        });
      } catch (error) {
        console.error('Failed to load articles:', error);
      }
    };
    loadArticles();
  }, []);

  return (
    <div className="mediascope-dashboard">
      <header className="dashboard-header">
        <div className="logo-section">
          <h1>ğŸ“° MediaScope</h1>
          <p className="tagline">Dawn Newspaper Archive (1990-1992)</p>
        </div>
        <nav className="dashboard-nav">
          <button
            className={activeTab === 'search' ? 'active' : ''}
            onClick={() => setActiveTab('search')}
          >
            ğŸ” Search
          </button>
          <button
            className={activeTab === 'trends' ? 'active' : ''}
            onClick={() => setActiveTab('trends')}
          >
            ğŸ“ˆ Trends
          </button>
          <button
            className={activeTab === 'analytics' ? 'active' : ''}
            onClick={() => setActiveTab('analytics')}
          >
            ğŸ“Š Analytics
          </button>
        </nav>
      </header>

      <main className="dashboard-main">
        {activeTab === 'search' && (
          <div className="search-view">
            <SearchPanel onResults={setSearchResults} />
            {searchResults && (
              <div className="search-results">
                <div className="results-header">
                  <h3>ğŸ“„ Found {searchResults.total} articles</h3>
                </div>
                <ArticleList articles={searchResults.articles || []} />
              </div>
            )}
          </div>
        )}

        {activeTab === 'trends' && (
          <div className="trends-view">
            <KeywordTrendChart />
            <AISummaryPanel />
          </div>
        )}

        {activeTab === 'analytics' && (
          <div className="analytics-view">
            <div className="analytics-grid">
              <div className="analytics-card">
                <TopEntitiesPanel />
              </div>
              <div className="analytics-card">
                <SentimentDistribution />
              </div>
            </div>
          </div>
        )}
      </main>
    </div>
  );
};

export default MediaScopeDashboard;
